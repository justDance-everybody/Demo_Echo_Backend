# Echo AI åç«¯è‡ªåŠ¨åŒ–APIæµ‹è¯•

## ğŸ“‹ æ¦‚è¿°

æœ¬æµ‹è¯•å¥—ä»¶ä¸ºEcho AIåç«¯æœåŠ¡æä¾›å®Œæ•´çš„è‡ªåŠ¨åŒ–APIæµ‹è¯•ï¼ŒåŸºäºäº§å“éœ€æ±‚æ–‡æ¡£(PRD)å’ŒAPIè§„èŒƒï¼Œç³»ç»Ÿæ€§åœ°éªŒè¯åç«¯åŠŸèƒ½å®Œæ•´æ€§ï¼Œè¯†åˆ«ä¸å¯ç”¨æ¥å£ï¼Œç¡®ä¿ç³»ç»Ÿè´¨é‡ã€‚

## ğŸ—ï¸ æµ‹è¯•ç»“æ„

```
app/tests/
â”œâ”€â”€ __init__.py                    # æµ‹è¯•åŒ…åˆå§‹åŒ–
â”œâ”€â”€ conftest.py                    # æµ‹è¯•é…ç½®å’Œå…±äº«fixture
â”œâ”€â”€ test_auth_permissions.py       # è®¤è¯ä¸æƒé™æµ‹è¯•
â”œâ”€â”€ test_core_ai_flow.py          # æ ¸å¿ƒAIäº¤äº’æµç¨‹æµ‹è¯•
â”œâ”€â”€ test_developer_features.py     # å¼€å‘è€…åŠŸèƒ½æµ‹è¯•
â”œâ”€â”€ test_performance_stability.py  # æ€§èƒ½ä¸ç¨³å®šæ€§æµ‹è¯•
â”œâ”€â”€ test_error_handling.py         # é”™è¯¯å¤„ç†æµ‹è¯•
â””â”€â”€ README.md                      # æœ¬æ–‡ä»¶
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
cd backend
source venv/bin/activate

# å®‰è£…æµ‹è¯•ä¾èµ–
pip install pytest pytest-cov pytest-asyncio
```

### 2. è¿è¡Œæµ‹è¯•

#### ä½¿ç”¨ä¾¿æ·è„šæœ¬ï¼ˆæ¨èï¼‰
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
python run_tests.py

# è¿è¡Œç‰¹å®šç±»å‹æµ‹è¯•
python run_tests.py --auth          # è®¤è¯æµ‹è¯•
python run_tests.py --core          # æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•
python run_tests.py --dev           # å¼€å‘è€…åŠŸèƒ½æµ‹è¯•
python run_tests.py --performance   # æ€§èƒ½æµ‹è¯•
python run_tests.py --errors        # é”™è¯¯å¤„ç†æµ‹è¯•

# å¿«é€Ÿæµ‹è¯•æ¨¡å¼
python run_tests.py --quick

# è¯¦ç»†è¾“å‡º
python run_tests.py --verbose

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
python run_tests.py --coverage
```

#### ä½¿ç”¨pytestç›´æ¥è¿è¡Œ
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest app/tests/

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
pytest app/tests/test_auth_permissions.py

# è¿è¡Œç‰¹å®šæµ‹è¯•ç±»
pytest app/tests/test_auth_permissions.py::TestUserAuthentication

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–¹æ³•
pytest app/tests/test_auth_permissions.py::TestUserAuthentication::test_user_login_success

# è¯¦ç»†è¾“å‡º
pytest -v app/tests/

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
pytest --cov=app --cov-report=html app/tests/
```

## ğŸ“Š æµ‹è¯•è¦†ç›–èŒƒå›´

### 1. è®¤è¯ä¸æƒé™æµ‹è¯• (`test_auth_permissions.py`)

**æµ‹è¯•ç›®æ ‡**: éªŒè¯JWTè®¤è¯æœºåˆ¶å’Œæƒé™æ§åˆ¶

**æµ‹è¯•ç”¨ä¾‹**:
- âœ… ç”¨æˆ·è®¤è¯æµç¨‹ï¼ˆç™»å½•ã€æ³¨å†Œï¼‰
- âœ… æƒé™æ§åˆ¶éªŒè¯ï¼ˆè§’è‰²å±‚çº§ã€æ¥å£è®¿é—®æ§åˆ¶ï¼‰
- âœ… TokenéªŒè¯ï¼ˆæœ‰æ•ˆã€æ— æ•ˆã€è¿‡æœŸï¼‰
- âœ… è¾¹ç•Œæƒ…å†µï¼ˆç©ºå‡­æ®ã€ç‰¹æ®Šå­—ç¬¦ã€Unicodeï¼‰

**éªŒæ”¶æ ‡å‡†**:
- ä¸‰ç§è§’è‰²ç™»å½•æˆåŠŸç‡ â‰¥ 95%
- æƒé™éªŒè¯å‡†ç¡®ç‡ = 100%
- è®¤è¯é”™è¯¯å¤„ç†è¦†ç›–ç‡ â‰¥ 90%

### 2. æ ¸å¿ƒAIäº¤äº’æµç¨‹æµ‹è¯• (`test_core_ai_flow.py`)

**æµ‹è¯•ç›®æ ‡**: éªŒè¯AIç†è§£ç”¨æˆ·æ„å›¾å’Œå·¥å…·è°ƒç”¨åŠŸèƒ½

**æµ‹è¯•ç”¨ä¾‹**:
- âœ… æ„å›¾è§£ææ¥å£ï¼ˆå¤©æ°”æŸ¥è¯¢ã€ç¿»è¯‘ã€æ— æ³•è¯†åˆ«æ„å›¾ï¼‰
- âœ… ç¡®è®¤æ‰§è¡Œæµç¨‹ï¼ˆç”¨æˆ·ç¡®è®¤æœºåˆ¶ï¼‰
- âœ… ç›´æ¥å·¥å…·æ‰§è¡Œï¼ˆç¿»è¯‘ã€å¤©æ°”æŸ¥è¯¢ï¼‰
- âœ… ç«¯åˆ°ç«¯æµç¨‹ï¼ˆå®Œæ•´AIäº¤äº’ï¼‰

**éªŒæ”¶æ ‡å‡†**:
- å¸¸è§æ„å›¾è¯†åˆ«å‡†ç¡®ç‡ â‰¥ 80%
- å·¥å…·è°ƒç”¨æˆåŠŸç‡ â‰¥ 90%
- æ„å›¾è§£ææ—¶é—´ â‰¤ 200ms
- å·¥å…·æ‰§è¡Œæ—¶é—´ â‰¤ 300ms
- ç«¯åˆ°ç«¯å“åº”æ—¶é—´ â‰¤ 500ms

### 3. å¼€å‘è€…åŠŸèƒ½æµ‹è¯• (`test_developer_features.py`)

**æµ‹è¯•ç›®æ ‡**: éªŒè¯å¼€å‘è€…æ§åˆ¶å°åŠŸèƒ½

**æµ‹è¯•ç”¨ä¾‹**:
- âœ… å·¥å…·ç®¡ç†ï¼ˆåˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ã€æµ‹è¯•ï¼‰
- âœ… åº”ç”¨ç®¡ç†ï¼ˆåˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ã€å‘å¸ƒï¼‰
- âœ… MCPæœåŠ¡å™¨çŠ¶æ€ç›‘æ§
- âœ… æƒé™è¾¹ç•Œæµ‹è¯•

**éªŒæ”¶æ ‡å‡†**:
- å¼€å‘è€…åŠŸèƒ½å¯ç”¨æ€§ = 100%
- æƒé™æ§åˆ¶æœ‰æ•ˆæ€§ = 100%

### 4. æ€§èƒ½ä¸ç¨³å®šæ€§æµ‹è¯• (`test_performance_stability.py`)

**æµ‹è¯•ç›®æ ‡**: éªŒè¯ç³»ç»Ÿæ€§èƒ½ç¬¦åˆPRDè¦æ±‚

**æµ‹è¯•ç”¨ä¾‹**:
- âœ… å¹¶å‘è¯·æ±‚æµ‹è¯•ï¼ˆâ‰¥10 QPSï¼‰
- âœ… å“åº”æ—¶é—´è¦æ±‚éªŒè¯
- âœ… ç³»ç»Ÿç¨³å®šæ€§æµ‹è¯•
- âœ… èµ„æºä½¿ç”¨ç›‘æ§

**éªŒæ”¶æ ‡å‡†**:
- å¹¶å‘å¤„ç†èƒ½åŠ› â‰¥ 10 QPS
- ç³»ç»Ÿå¯ç”¨æ€§ â‰¥ 99%
- é•¿æ—¶é—´è¿è¡Œç¨³å®šæ€§ â‰¥ 90%

### 5. é”™è¯¯å¤„ç†æµ‹è¯• (`test_error_handling.py`)

**æµ‹è¯•ç›®æ ‡**: éªŒè¯å¼‚å¸¸æƒ…å†µå¾—åˆ°æ­£ç¡®å¤„ç†

**æµ‹è¯•ç”¨ä¾‹**:
- âœ… è®¤è¯é”™è¯¯å¤„ç†
- âœ… å‚æ•°éªŒè¯é”™è¯¯
- âœ… ä¸šåŠ¡é€»è¾‘é”™è¯¯
- âœ… è¾¹ç•Œæ¡ä»¶æµ‹è¯•
- âœ… é”™è¯¯å“åº”æ ¼å¼éªŒè¯

**éªŒæ”¶æ ‡å‡†**:
- å¼‚å¸¸æƒ…å†µå¤„ç†è¦†ç›–ç‡ â‰¥ 90%
- é”™è¯¯å“åº”æ ¼å¼ä¸€è‡´æ€§ = 100%

## ğŸ”§ æµ‹è¯•é…ç½®

### æµ‹è¯•ç¯å¢ƒè®¾ç½®

æµ‹è¯•ä½¿ç”¨å†…å­˜æ•°æ®åº“ï¼Œé¿å…å½±å“ç”Ÿäº§æ•°æ®ï¼š

```python
# conftest.py
SQLALCHEMY_DATABASE_URL = "sqlite:///:memory:"
```

### æµ‹è¯•ç”¨æˆ·é…ç½®

æµ‹è¯•ä½¿ç”¨é¢„ç½®çš„æµ‹è¯•è´¦å·ï¼š

```python
test_users = {
    "user": {
        "username": "testuser_5090",
        "password": "8lpcUY2BOt",
        "role": "user"
    },
    "developer": {
        "username": "devuser_5090",
        "password": "mryuWTGdMk",
        "role": "developer"
    },
    "admin": {
        "username": "adminuser_5090",
        "password": "SAKMRtxCjT",
        "role": "admin"
    }
}
```

### æµ‹è¯•æ•°æ®éš”ç¦»

æ¯ä¸ªæµ‹è¯•ä½¿ç”¨ç‹¬ç«‹çš„session_idï¼Œé¿å…æ•°æ®å†²çªï¼š

```python
def generate_session_id():
    return f"test-session-{datetime.now().strftime('%Y%m%d%H%M%S')}"
```

## ğŸ“ˆ æµ‹è¯•æŠ¥å‘Š

### è¦†ç›–ç‡æŠ¥å‘Š

```bash
# ç”ŸæˆHTMLè¦†ç›–ç‡æŠ¥å‘Š
pytest --cov=app --cov-report=html app/tests/

# æŸ¥çœ‹æŠ¥å‘Š
open htmlcov/index.html
```

### æµ‹è¯•ç»“æœåˆ†æ

```bash
# è¿è¡Œæµ‹è¯•å¹¶æ˜¾ç¤ºæœ€æ…¢çš„æµ‹è¯•
pytest --durations=10 app/tests/

# ç”ŸæˆJUnit XMLæŠ¥å‘Š
pytest --junitxml=test-results.xml app/tests/
```

## ğŸš¨ å¸¸è§é—®é¢˜

### 1. æµ‹è¯•ç¯å¢ƒé—®é¢˜

**é—®é¢˜**: æ•°æ®åº“è¿æ¥å¤±è´¥
**è§£å†³**: ç¡®ä¿ä½¿ç”¨å†…å­˜æ•°æ®åº“ï¼Œæ£€æŸ¥conftest.pyé…ç½®

**é—®é¢˜**: ä¾èµ–åŒ…ç¼ºå¤±
**è§£å†³**: å®‰è£…æµ‹è¯•ä¾èµ– `pip install pytest pytest-cov pytest-asyncio`

### 2. æµ‹è¯•æ‰§è¡Œé—®é¢˜

**é—®é¢˜**: æµ‹è¯•è¶…æ—¶
**è§£å†³**: ä½¿ç”¨ `--quick` æ¨¡å¼è·³è¿‡è€—æ—¶æµ‹è¯•

**é—®é¢˜**: æƒé™é”™è¯¯
**è§£å†³**: æ£€æŸ¥æµ‹è¯•ç”¨æˆ·é…ç½®å’ŒJWTå¯†é’¥è®¾ç½®

### 3. æ€§èƒ½æµ‹è¯•é—®é¢˜

**é—®é¢˜**: æ€§èƒ½æµ‹è¯•å¤±è´¥
**è§£å†³**: æ£€æŸ¥ç³»ç»Ÿèµ„æºï¼Œè°ƒæ•´å¹¶å‘æ•°é‡

## ğŸ”„ æŒç»­é›†æˆ

### GitHub Actionsé…ç½®ç¤ºä¾‹

```yaml
name: API Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.9
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov
      - name: Run tests
        run: |
          cd backend
          python run_tests.py --coverage
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [åç«¯é›†æˆæµ‹è¯•ç”¨ä¾‹ä¸éªŒæ”¶æ ‡å‡†](../docs/åç«¯é›†æˆæµ‹è¯•ç”¨ä¾‹ä¸éªŒæ”¶æ ‡å‡†.md)
- [å‰åç«¯å¯¹æ¥ä¸APIè§„èŒƒ](../docs/å‰åç«¯å¯¹æ¥ä¸APIè§„èŒƒ.md)
- [äº§å“éœ€æ±‚æ–‡æ¡£(PRD)](../docs/äº§å“å¼€å‘éœ€æ±‚æ–‡æ¡£PRD.md)

## ğŸ¤ è´¡çŒ®æŒ‡å—

### æ·»åŠ æ–°æµ‹è¯•

1. åœ¨ç›¸åº”çš„æµ‹è¯•æ–‡ä»¶ä¸­æ·»åŠ æµ‹è¯•æ–¹æ³•
2. éµå¾ªå‘½åè§„èŒƒï¼š`test_<åŠŸèƒ½>_<åœºæ™¯>`
3. æ·»åŠ è¯¦ç»†çš„æ–‡æ¡£å­—ç¬¦ä¸²
4. ç¡®ä¿æµ‹è¯•æ•°æ®éš”ç¦»

### æµ‹è¯•æœ€ä½³å®è·µ

- âœ… æ¯ä¸ªæµ‹è¯•åº”è¯¥ç‹¬ç«‹ä¸”å¯é‡å¤
- âœ… ä½¿ç”¨æè¿°æ€§çš„æµ‹è¯•åç§°
- âœ… éªŒè¯æˆåŠŸå’Œå¤±è´¥æƒ…å†µ
- âœ… æ¸…ç†æµ‹è¯•æ•°æ®
- âœ… æ·»åŠ é€‚å½“çš„æ–­è¨€æ¶ˆæ¯

## ğŸ“ æ”¯æŒä¸åé¦ˆ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·ï¼š

1. æ£€æŸ¥æµ‹è¯•æ—¥å¿—å’Œé”™è¯¯ä¿¡æ¯
2. æŸ¥çœ‹ç›¸å…³æ–‡æ¡£
3. è”ç³»åç«¯å¼€å‘å›¢é˜Ÿ

---

**æœ€åæ›´æ–°**: 2025-01-14
**æµ‹è¯•ç‰ˆæœ¬**: v1.0.0
**ç»´æŠ¤å›¢é˜Ÿ**: åç«¯å¼€å‘å›¢é˜Ÿ
